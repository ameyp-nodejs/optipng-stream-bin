#!/usr/bin/env node
'use strict';

var binPath = require('optipng-bin').path;
var spawn = require('child_process').spawn;
var tmp = require('tmp');
var fs = require('fs');
var concat = require('concat-stream');

tmp.tmpName(function(err, inFile) {
    process.stdin.pipe(concat(function(data) {
	fs.writeFile(inFile, data, function(err) {
	    if (err) throw err;
	    tmp.tmpName(function(err, outFile) {
		var proc = spawn(binPath,
				 process.argv.slice(2).concat(['-out', outFile, inFile]),
				 { stdio: 'inherit' });
		proc.on('exit', function() {
		    fs.createReadStream(outFile)
			.pipe(process.stdout);
		});
	    });
	});
    }));
});
